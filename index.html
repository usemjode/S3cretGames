<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gabriel Messages - ChromeOS</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --accent: #1a73e8; --shelf-bg: rgba(32, 33, 36, 0.95); --dark-bg: #1a1c1e; --sidebar-bg: #282a2d; --meet-bg: #202124; }
        * { box-sizing: border-box; font-family: 'Google Sans', Roboto, sans-serif; transition: 0.1s ease-out; }
        
        body { margin: 0; height: 100vh; width: 100vw; overflow: hidden; background: url('https://images.wallpapersden.com/image/download/google-chrome-os-official-stock_bWlpZmqUmZqaraWkpJRmbmdlrWZnZWU.jpg') center/cover; }

        /* BANNER */
        #announcement-banner { position: fixed; top: -60px; left: 0; right: 0; height: 50px; background: #fbbc04; color: #202124; display: flex; align-items: center; justify-content: center; font-weight: bold; z-index: 99999; transition: top 0.5s ease; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }

        /* OVERLAYS */
        .overlay { position: fixed; inset: 0; z-index: 50000; background: white; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .card { background: white; width: 450px; padding: 40px; border-radius: 28px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #ddd; outline: none; display: block; }
        
        .btn { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .full-btn { width: 100%; margin-top: 15px; padding: 12px; }
        .google-btn { background: white; color: #3c4043; border: 1px solid #dadce0; padding: 10px; border-radius: 20px; width: 100%; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; margin-bottom: 10px; }

        /* EMAIL GUARD (SECURITY GATE) */
        #email-guard { position: absolute; inset: 0; background: rgba(26, 28, 30, 0.9); backdrop-filter: blur(10px); z-index: 40000; display: none; align-items: center; justify-content: center; flex-direction: column; padding: 20px; text-align: center; border-radius: 0 0 16px 0; }
        .guard-card { background: white; color: #202124; padding: 25px; border-radius: 20px; max-width: 320px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        /* APP WINDOW */
        #app-window {
            position: fixed; top: 5%; left: 10%; width: 80%; height: 80%; background: var(--dark-bg); border-radius: 16px; display: none;
            flex-direction: column; z-index: 30000; box-shadow: 0 20px 80px rgba(0,0,0,0.6); overflow: hidden; color: white;
            resize: both; min-width: 450px; min-height: 400px;
        }
        .win-header { padding: 10px 20px; background: #202124; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; cursor: move; user-select: none; }
        .close-dot { background: #ff5f56; border: none; width: 14px; height: 14px; border-radius: 50%; cursor: pointer; }

        /* SHELF & ICONS */
        #shelf { position: fixed; bottom: 0; left: 0; right: 0; height: 52px; background: var(--shelf-bg); display: none; align-items: center; padding: 0 15px; z-index: 10000; }
        .shelf-icon { width: 40px; height: 40px; margin-right: 10px; cursor: pointer; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .shelf-icon:hover { background: rgba(255,255,255,0.1); }
        .shelf-icon img { width: 32px; height: 32px; }
        #clock { color: white; font-size: 13px; font-weight: bold; margin-left: auto; }

        /* MESSENGER ELEMENTS */
        #messenger-content { display: flex; flex: 1; overflow: hidden; position: relative; }
        .msg-sidebar { width: 280px; background: var(--sidebar-bg); border-right: 1px solid #333; display: flex; flex-direction: column; }
        .chat-main { flex: 1; display: flex; flex-direction: column; background: var(--dark-bg); position: relative; }
        #chat-box { flex: 1; padding: 20px; overflow-y: auto; display: none; flex-direction: column; gap: 12px; }
        .msg-bubble { max-width: 70%; padding: 10px 14px; border-radius: 18px; font-size: 14px; }
        .msg-me { background: var(--accent); align-self: flex-end; border-bottom-right-radius: 4px; }
        .msg-remote { background: #303134; align-self: flex-start; border-bottom-left-radius: 4px; }
        #msg-input-area { padding: 15px; background: #202124; display: none; gap: 10px; border-top: 1px solid #333; }
    </style>
</head>
<body>

    <div id="announcement-banner">ðŸ“¢ <span id="ann-content" style="margin-left:10px;"></span></div>

    <div id="login-overlay" class="overlay">
        <div class="card">
            <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="40" style="margin-bottom:10px;">
            <h2>Gabriel Messages</h2>
            
            <button class="google-btn" onclick="handleGoogleLogin()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18">
                Sign in with Google
            </button>

            <div style="margin: 10px 0; color: #aaa; font-size: 12px;">OR</div>

            <form id="login-form" onsubmit="handleAuth(event)">
                <input type="email" id="u-in" placeholder="Email Address" required>
                <input type="password" id="p-in" placeholder="Password" required>
                <button type="submit" class="btn full-btn">Sign In / Register</button>
            </form>
        </div>
    </div>

    <div id="app-window">
        <div class="win-header" id="win-header">
            <span id="win-title" style="font-weight: bold;">Messages</span>
            <div style="display:flex; gap:12px; align-items:center;">
                <button onclick="handleLogout()" style="background:none; border:none; color:#aaa; cursor:pointer; font-size:11px;">Logout</button>
                <button class="close-dot" onclick="closeApp()"></button>
            </div>
        </div>
        
        <div id="messenger-content">
            <div class="msg-sidebar">
                <div style="padding:15px;"><button class="btn full-btn" onclick="switchChat('global')">Global Chat</button></div>
                <div id="contact-list" style="flex:1; overflow-y:auto;"></div>
            </div>

            <div class="chat-main">
                <div id="email-guard">
                    <div class="guard-card">
                        <h3 style="margin:0">Locking Chat...</h3>
                        <p style="font-size:12px; color:#666">Please verify your email to access conversations.</p>
                        <button class="btn full-btn" onclick="location.reload()">I've Verified</button>
                    </div>
                </div>

                <div id="chat-landing" style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align: center; color:#9aa0a6;">
                    <img src="https://raw.githubusercontent.com/usemjode/Chatting/main/New%20Project%20-%202026-02-24T174003.122.png" width="120">
                    <p>Select a conversation to start</p>
                </div>
                <div id="chat-box"></div>
                <div id="msg-input-area">
                    <input type="text" id="msg-in" style="flex:1; background:#303134; color:white; border:none; padding:10px; border-radius:8px;" placeholder="Type a message..." onkeydown="if(event.key==='Enter') sendMsg()">
                    <button class="btn" onclick="sendMsg()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <div id="shelf">
        <div class="shelf-icon" onclick="openApp()">
            <img src="https://raw.githubusercontent.com/usemjode/Chatting/main/New%20Project%20-%202026-02-24T174003.122.png">
        </div>
        <div id="clock">12:00 PM</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, get, set, push, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyDbDnA1BZ5wjWVlOLIHAVj_6zaA7p95q28", 
            authDomain: "chatting-b47d3.firebaseapp.com", 
            databaseURL: "https://chatting-b47d3-default-rtdb.firebaseio.com/", 
            projectId: "chatting-b47d3" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const googleProvider = new GoogleAuthProvider();

        let currentUser = "", currentChatTarget = null, userDataCache = {};

        // --- AUTH HANDLERS ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user.email.split('@')[0].replace(/\./g, '_');
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('shelf').style.display = 'flex';
                openApp();

                // Email Guard Check
                document.getElementById('email-guard').style.display = user.email ? 'none' : 'flex';

                // Sync Presence
                set(ref(db, 'status/' + currentUser), { state: 'online' });
                onDisconnect(ref(db, 'status/' + currentUser)).set({ state: 'offline' });
                
                initMessenger();
                listenToAdmin();
            } else {
                document.getElementById('login-overlay').style.display = 'flex';
                document.getElementById('shelf').style.display = 'none';
                closeApp();
            }
        });

        window.handleAuth = async (e) => {
            e.preventDefault();
            const email = document.getElementById('u-in').value;
            const pass = document.getElementById('p-in').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (err) {
                if (err.code === 'auth/user-not-found') await createUserWithEmailAndPassword(auth, email, pass);
                else alert(err.message);
            }
        };

        window.handleGoogleLogin = () => signInWithPopup(auth, googleProvider);
        window.handleLogout = () => signOut(auth).then(() => location.reload());

        // --- WINDOW MGMT ---
        window.openApp = () => document.getElementById('app-window').style.display = 'flex';
        window.closeApp = () => document.getElementById('app-window').style.display = 'none';

        // Dragging Logic
        const win = document.getElementById("app-window");
        const header = document.getElementById("win-header");
        let isDragging = false, offset = { x: 0, y: 0 };
        header.onmousedown = (e) => { isDragging = true; offset.x = e.clientX - win.offsetLeft; offset.y = e.clientY - win.offsetTop; };
        document.onmousemove = (e) => { if (!isDragging) return; win.style.left = (e.clientX - offset.x) + "px"; win.style.top = (e.clientY - offset.y) + "px"; win.style.margin = "0"; };
        document.onmouseup = () => isDragging = false;

        // --- CHAT LOGIC ---
        function initMessenger() {
            onValue(ref(db, 'status'), (snap) => {
                const list = document.getElementById('contact-list');
                list.innerHTML = "";
                snap.forEach(u => {
                    if(u.key === currentUser) return;
                    list.innerHTML += `
                        <div style="padding:12px; display:flex; align-items:center; gap:10px; cursor:pointer;" onclick="switchChat('${u.key}')">
                            <div style="width:35px; height:35px; border-radius:50%; background:#444; display:flex; align-items:center; justify-content:center;">${u.key[0].toUpperCase()}</div>
                            <div style="flex:1; font-size:13px;">${u.key}</div>
                            <div style="width:8px; height:8px; border-radius:50%; background:${u.val().state==='online'?'#34a853':'#555'}"></div>
                        </div>`;
                });
            });
        }

        window.switchChat = (t) => {
            currentChatTarget = t;
            document.getElementById('chat-landing').style.display = 'none';
            document.getElementById('chat-box').style.display = 'flex';
            document.getElementById('msg-input-area').style.display = 'flex';
            document.getElementById('win-title').innerText = "Chat with " + t;
            loadMessages();
        };

        function loadMessages() {
            const path = currentChatTarget === 'global' ? 'chats/global' : 'chats/dms/' + [currentUser, currentChatTarget].sort().join('_');
            onValue(ref(db, path), (snap) => {
                const box = document.getElementById('chat-box'); box.innerHTML = "";
                snap.forEach(m => {
                    const d = m.val();
                    box.innerHTML += `<div class="msg-bubble ${d.user===currentUser?'msg-me':'msg-remote'}">
                        <small style="opacity:0.5">${d.user}</small><br>${d.text}
                    </div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        window.sendMsg = () => {
            const i = document.getElementById('msg-in'); if(!i.value) return;
            const path = currentChatTarget === 'global' ? 'chats/global' : 'chats/dms/' + [currentUser, currentChatTarget].sort().join('_');
            push(ref(db, path), { user: currentUser, text: i.value });
            i.value = "";
        };

        function listenToAdmin() {
            onValue(ref(db, 'commands'), (snap) => {
                const data = snap.val() || {};
                if(data.wallpaper) document.body.style.background = `url('${data.wallpaper}') center/cover no-repeat fixed`;
                if(data.announcement) {
                    document.getElementById('ann-content').innerText = data.announcement.text;
                    document.getElementById('announcement-banner').style.top = "0px";
                } else {
                    document.getElementById('announcement-banner').style.top = "-60px";
                }
            });
        }

        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' }); }, 1000);
    </script>
</body>
</html>
